<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control MES</title>
    <style>
        :root {
            --bg-body: #121212;
            --text-main: #ffffff;
            --bg-card: #1e1e1e;
            --shadow-card: rgba(0, 0, 0, 0.5);
            --border-h2: #333;
            --bg-btn: #2c2c2c;
            --border-btn: #444;
            --hover-btn: #3d3d3d;
            --hover-border-btn: #666;
            --bg-input: #121212;
            --text-muted: #aaa;
            --border-input: #444;
        }

        .light-theme {
            --bg-body: #f5f7fa;
            --text-main: #2d3748;
            --bg-card: #ffffff;
            --shadow-card: rgba(0, 0, 0, 0.08);
            --border-h2: #e2e8f0;
            --bg-btn: #edf2f7;
            --border-btn: #cbd5e0;
            --hover-btn: #e2e8f0;
            --hover-border-btn: #a0aec0;
            --bg-input: #ffffff;
            --text-muted: #718096;
            --border-input: #cbd5e0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
        }

        .main-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 30px;
            width: 100%;
            max-width: 1100px;
            padding: 40px 20px;
            box-sizing: border-box;
        }

        .card {
            background-color: var(--bg-card);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 30px var(--shadow-card);
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        h2 {
            color: var(--text-main);
            font-size: 20px;
            margin-top: 0;
            margin-bottom: 25px;
            font-weight: 600;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border-h2);
            padding-bottom: 10px;
        }

        /* Botones de Control */
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        button {
            background-color: var(--bg-btn);
            color: var(--text-main);
            padding: 14px 20px;
            border: 1px solid var(--border-btn);
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        button:active {
            transform: scale(0.98);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        button:hover:not(:disabled) {
            background-color: var(--hover-btn);
            border-color: var(--hover-border-btn);
        }

        /* Colores espec√≠ficos Control */
        .btn-start {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            border: none;
            box-shadow: 0 4px 15px rgba(56, 239, 125, 0.3);
        }

        .btn-start:hover:not(:disabled) {
            box-shadow: 0 6px 20px rgba(56, 239, 125, 0.5);
            background: linear-gradient(135deg, #15b7aa, #42f58c);
        }

        .btn-stop {
            background: linear-gradient(135deg, #cb2d3e, #ef473a);
            border: none;
            box-shadow: 0 4px 15px rgba(239, 71, 58, 0.3);
        }

        .btn-stop:hover:not(:disabled) {
            box-shadow: 0 6px 20px rgba(239, 71, 58, 0.5);
            background: linear-gradient(135deg, #d83446, #fa5245);
        }

        .btn-pause {
            background: linear-gradient(135deg, #f2994a, #f2c94c);
            border: none;
            box-shadow: 0 4px 15px rgba(242, 201, 76, 0.3);
            color: #111;
        }

        .btn-pause:hover:not(:disabled) {
            box-shadow: 0 6px 20px rgba(242, 201, 76, 0.5);
            background: linear-gradient(135deg, #faaa55, #fce055);
        }

        /* Formulario Nueva Caja */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-muted);
            font-size: 14px;
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 10px;
            background-color: var(--bg-input);
            border: 1px solid var(--border-input);
            color: var(--text-main);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 14px;
        }

        input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }

        .btn-submit {
            background-color: #007bff;
            color: #fff;
            border: none;
            margin-top: 10px;
        }

        .btn-submit:hover:not(:disabled) {
            background-color: #0069d9;
        }

        /* Notificaciones y Carga */
        .message {
            margin-top: 20px;
            font-weight: bold;
            display: none;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
        }

        .success {
            background-color: rgba(40, 167, 69, 0.2);
            color: #4ade80;
            border: 1px solid rgba(40, 167, 69, 0.3);
        }

        .error {
            background-color: rgba(220, 53, 69, 0.2);
            color: #ff6b6b;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }

        .loading {
            margin-top: 20px;
            color: var(--text-muted);
            display: none;
            font-size: 14px;
            text-align: center;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .caja-info {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: normal;
            display: block;
            margin-top: 4px;
        }

        .box-btn {
            justify-content: flex-start;
            text-align: left;
        }

        .box-image {
            width: 45px;
            height: 45px;
            object-fit: cover;
            border-radius: 6px;
            flex-shrink: 0;
            background-color: #fff;
        }

        .box-image-placeholder {
            width: 45px;
            height: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--border-h2);
            border-radius: 6px;
            font-size: 20px;
            flex-shrink: 0;
        }

        .box-content-info {
            display: flex;
            flex-direction: column;
            text-align: left;
        }

        .box-title {
            font-size: 16px;
            font-weight: bold;
        }

        /* Nav y Tabs */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 15px 40px;
            background-color: var(--bg-card);
            box-shadow: 0 2px 10px var(--shadow-card);
            box-sizing: border-box;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar .tabs {
            display: flex;
            gap: 10px;
            overflow-x: auto;
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 16px;
            font-weight: 600;
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            border-radius: 0;
            width: auto;
            white-space: nowrap;
        }

        .tab-btn:hover {
            color: var(--text-main);
            background: rgba(255, 255, 255, 0.05);
        }

        .tab-btn.active {
            color: #007bff;
            border-bottom: 3px solid #007bff;
        }

        .theme-toggle {
            background: transparent;
            border: 1px solid var(--border-btn);
            font-size: 20px;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            width: auto;
        }

        .tab-content {
            display: none;
            width: 100%;
            animation: fadeIn 0.3s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <!-- Header / Navbar -->
    <div class="navbar">
        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('tab-gestion', this)">Gesti√≥n de m√°quinas y
                productos</button>
            <button class="tab-btn" onclick="openTab('tab-dashboard', this)">Dashboard statistics</button>
            <button class="tab-btn" onclick="openTab('tab-status', this)">Status machine</button>
        </div>
        <button class="theme-toggle" id="theme-btn" onclick="toggleTheme()" title="Cambiar tema">‚òÄÔ∏è</button>
    </div>

    <!-- Pesta√±a 1: Gesti√≥n de m√°quinas y productos -->
    <div id="tab-gestion" class="tab-content active">
        <div class="main-container">
            <!-- SECCI√ìN 1: Control de M√°quina -->
            <div class="card">
                <h2>‚öôÔ∏è Control de M√°quina</h2>
                <div class="button-group">
                    <button class="btn-start" onclick="sendControl(1)">
                        ‚ñ∂ START
                    </button>
                    <button class="btn-pause" onclick="sendControl(2)">
                        ‚è∏ PAUSE
                    </button>
                    <button class="btn-stop" onclick="sendControl(0)">
                        ‚èπ STOP
                    </button>
                </div>
                <div id="loading-control" class="loading">
                    <div class="spinner"></div> Enviando...
                </div>
                <div id="res-control" class="message"></div>
            </div>

            <!-- SECCI√ìN 2: Selecci√≥n de Producto -->
            <div class="card">
                <h2>üì¶ Producto (Cajas)</h2>
                <div id="box-list" class="button-group">
                    <!-- Se llenar√° din√°micamente con JS -->
                    <div style="text-align:center; color:#888;">Cargando cajas...</div>
                </div>
                <div id="loading-box" class="loading">
                    <div class="spinner"></div> Configurando producto...
                </div>
                <div id="res-box" class="message"></div>
            </div>

            <!-- SECCI√ìN 3: Nueva Caja -->
            <div class="card">
                <h2>‚ûï Definir Nueva Caja</h2>
                <form id="newBoxForm">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <div class="form-group" style="flex:2;">
                            <label>Nombre del formato</label>
                            <input type="text" id="box_name" placeholder="Ej: Extra Grande" required>
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label>ID Box Type</label>
                            <input type="number" id="box_type_id" placeholder="Ej: 4" required min="1">
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <div class="form-group" style="flex:1;">
                            <label>Altura</label>
                            <input type="number" id="box_h" required min="1">
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label>Anchura</label>
                            <input type="number" id="box_w" required min="1">
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label>Largo</label>
                            <input type="number" id="box_l" required min="1">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Imagen del Producto (Opcional)</label>
                        <input type="file" id="box_image" accept="image/*"
                            style="background: none; border:none; padding: 0;">
                    </div>
                    <button type="submit" class="btn-submit" id="btn-create-box">Crear y Guardar</button>
                </form>
                <div id="loading-create" class="loading">
                    <div class="spinner"></div> Guardando...
                </div>
                <div id="res-create" class="message"></div>
            </div>
        </div> <!-- End main-container -->
    </div> <!-- End tab-gestion -->

    <!-- Pesta√±a 2: Dashboard statistics -->
    <div id="tab-dashboard" class="tab-content">
        <div class="main-container">
            <div class="card" style="grid-column: 1 / -1;">
                <h2>üìà Evoluci√≥n OEE (Availability, Performance, Quality)</h2>
                <canvas id="chartOEE" height="100"></canvas>
            </div>
            <div class="card">
                <h2>üìä Producci√≥n (OK vs NOK)</h2>
                <canvas id="chartProduction"></canvas>
            </div>
            <div class="card">
                <h2>‚è±Ô∏è Velocidad & Ciclo</h2>
                <canvas id="chartSpeed"></canvas>
            </div>
        </div>
    </div>

    <!-- Pesta√±a 3: Status machine -->
    <div id="tab-status" class="tab-content">
        <div class="main-container" id="kpi-container">
            <!-- Se generar√° din√°micamente con JS -->
            <div style="text-align:center; color:#888; width: 100%;">Esperando datos en tiempo real...</div>
        </div>
    </div>

    <!-- Cargar Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // --- INICIALIZACI√ìN ---
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            loadBoxes();
        });

        // --- SISTEMA DE PESTA√ëAS ---
        function openTab(tabId, btnElement) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            // Quitar 'active' a todos los botones
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

            // Mostrar pesta√±a actual
            document.getElementById(tabId).classList.add('active');
            btnElement.classList.add('active');

            // Cargar datos a demanda
            if (tabId === 'tab-dashboard' && !window.chartsLoaded) {
                loadDashboardData();
            } else if (tabId === 'tab-status' && !window.kpiLoopStarted) {
                startKPILoop();
            }
        }

        // --- SISTEMA DE TEMAS (DARK/LIGHT) ---
        function initTheme() {
            const isLight = localStorage.getItem('theme') === 'light';
            if (isLight) {
                document.body.classList.add('light-theme');
                document.getElementById('theme-btn').innerText = 'üåô';
            }
        }

        function toggleTheme() {
            const body = document.body;
            body.classList.toggle('light-theme');

            const isLight = body.classList.contains('light-theme');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            document.getElementById('theme-btn').innerText = isLight ? 'üåô' : '‚òÄÔ∏è';

            // Actualizar gr√°ficos si est√°n cargados para que el texto sea visible
            if (window.chartsLoaded) {
                updateChartsTheme(isLight);
            }
        }

        // --- FUNCIONES DE M√ÅQUINA (START/STOP/PAUSE) ---
        async function sendControl(valor) {
            const resultDiv = document.getElementById('res-control');
            const loadingDiv = document.getElementById('loading-control');
            toggleUI(true, resultDiv, loadingDiv);

            try {
                const response = await fetch('/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ valor: valor })
                });
                const data = await response.json();

                let cmdName = valor === 1 ? 'START' : (valor === 0 ? 'STOP' : 'PAUSE');
                showMessage(response.ok, response.ok ? `‚úÖ Comando <b>${cmdName}</b> ejecutado.` : `‚ùå ${data.error}`, resultDiv);
            } catch (error) {
                showMessage(false, `‚ùå Error: ${error.message}`, resultDiv);
            } finally {
                toggleUI(false, resultDiv, loadingDiv);
            }
        }

        // --- CARGA DE DATOS DASHBOARD (Chart.js) ---
        let oeeChart, prodChart, speedChart;

        async function loadDashboardData() {
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();

                if (!data || data.length === 0) return;

                const labels = data.map(d => d.db_timestamp.substring(11, 19)); // HH:MM:SS

                // Color variables for themes
                const isLight = document.body.classList.contains('light-theme');
                const getGridColor = () => isLight ? '#e2e8f0' : '#444';
                const getTextColor = () => isLight ? '#4a5568' : '#aaa';

                const commonOptions = {
                    responsive: true,
                    scales: {
                        x: { ticks: { color: getTextColor() }, grid: { color: getGridColor() } },
                        y: { ticks: { color: getTextColor() }, grid: { color: getGridColor() } }
                    },
                    plugins: { legend: { labels: { color: getTextColor() } } }
                };

                // OEE Line Chart
                const ctxOEE = document.getElementById('chartOEE').getContext('2d');
                oeeChart = new Chart(ctxOEE, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Availability (%)', data: data.map(d => parseFloat(String(d.Availability || 0).replace(',', '.'))), borderColor: '#38ef7d', tension: 0.3 },
                            { label: 'Performance (%)', data: data.map(d => parseFloat(String(d.Performance || 0).replace(',', '.'))), borderColor: '#007bff', tension: 0.3 },
                            { label: 'Quality (%)', data: data.map(d => parseFloat(String(d.Quality || 0).replace(',', '.'))), borderColor: '#f2c94c', tension: 0.3 }
                        ]
                    },
                    options: commonOptions
                });

                // Production Bar Chart
                const ctxProd = document.getElementById('chartProduction').getContext('2d');
                prodChart = new Chart(ctxProd, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Parts OK', data: data.map(d => d.Parts_OK || 0), backgroundColor: 'rgba(56, 239, 125, 0.7)' },
                            { label: 'Parts NOK', data: data.map(d => d.Parts_NOK || 0), backgroundColor: 'rgba(239, 71, 58, 0.7)' }
                        ]
                    },
                    options: commonOptions
                });

                // Speed & Cycle Chart
                const ctxSpeed = document.getElementById('chartSpeed').getContext('2d');
                speedChart = new Chart(ctxSpeed, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Target Speed', data: data.map(d => parseFloat(String(d.Target_Speed || 0).replace(',', '.'))), borderColor: '#f2994a', borderDash: [5, 5] },
                            { label: 'Cycle Time (s)', data: data.map(d => parseFloat(String(d.Last_Cycle_Time || 0).replace(',', '.'))), borderColor: '#9b51e0' }
                        ]
                    },
                    options: commonOptions
                });

                window.chartsLoaded = true;

            } catch (e) {
                console.error("Error cargando dashboard:", e);
            }
        }

        function updateChartsTheme(isLight) {
            const gridColor = isLight ? '#e2e8f0' : '#444';
            const textColor = isLight ? '#4a5568' : '#aaa';

            [oeeChart, prodChart, speedChart].forEach(chart => {
                if (chart) {
                    chart.options.scales.x.ticks.color = textColor;
                    chart.options.scales.x.grid.color = gridColor;
                    chart.options.scales.y.ticks.color = textColor;
                    chart.options.scales.y.grid.color = gridColor;
                    chart.options.plugins.legend.labels.color = textColor;
                    chart.update();
                }
            });
        }

        // --- SISTEMA KPI EN DIRECTO ---
        async function fetchKPIs() {
            try {
                const res = await fetch('/api/kpi');
                if (!res.ok) return;
                const data = await res.json();

                const container = document.getElementById('kpi-container');

                // Formateadores
                const isRunning = data.Heartbeat === 1;
                const stateColor = data.Machine_State === 4339 ? '#38ef7d' : '#f2c94c'; // Verde si ok, Amarillo si idle (ejemplo)

                container.innerHTML = `
                    <div class="card" style="text-align: center; border-bottom: 4px solid ${isRunning ? '#38ef7d' : '#ef473a'}">
                        <h3>Heartbeat</h3>
                        <div style="font-size: 32px; font-weight: bold; color: ${isRunning ? '#38ef7d' : '#ef473a'}">
                            ${isRunning ? '‚ù§Ô∏è ACTIVE' : 'üíî IDLE'}
                        </div>
                        <span class="caja-info">Actualizado: ${data.db_timestamp.substring(11, 19)}</span>
                    </div>

                    <div class="card" style="text-align: center; border-bottom: 4px solid ${stateColor}">
                        <h3>Machine State</h3>
                        <div style="font-size: 40px; font-weight: bold; color: ${stateColor}">${data.Machine_State || '-'}</div>
                    </div>

                    <div class="card" style="text-align: center;">
                        <h3>Total Parts Produced</h3>
                        <div style="font-size: 40px; font-weight: bold; color: #007bff">${data.Total_Parts_Produced || 0}</div>
                        <span style="color: #38ef7d">OK: ${data.Parts_OK || 0}</span> | 
                        <span style="color: #ef473a">NOK: ${data.Parts_NOK || 0}</span>
                    </div>

                    <div class="card" style="text-align: center;">
                        <h3>OEE Performance</h3>
                        <div style="display: flex; justify-content: space-between; margin-top: 15px;">
                            <div>
                                <div style="font-size: 20px; font-weight: bold;">${data.Availability || '0'}%</div>
                                <span class="caja-info">Availability</span>
                            </div>
                            <div>
                                <div style="font-size: 20px; font-weight: bold;">${data.Performance || '0'}%</div>
                                <span class="caja-info">Performance</span>
                            </div>
                            <div>
                                <div style="font-size: 20px; font-weight: bold;">${data.Quality || '0'}%</div>
                                <span class="caja-info">Quality</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card" style="text-align: center;">
                        <h3>Speed & Cycle</h3>
                        <div style="display: flex; justify-content: space-between; margin-top: 15px;">
                            <div>
                                <div style="font-size: 24px; font-weight: bold; color: #f2994a">${data.Target_Speed || '0'}</div>
                                <span class="caja-info">Target Speed</span>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: bold; color: #9b51e0">${data.Last_Cycle_Time || '0'}s</div>
                                <span class="caja-info">Last Cycle Time</span>
                            </div>
                        </div>
                    </div>
                `;

            } catch (e) {
                console.error("Error obtaining KPIs:", e);
            }
        }

        function startKPILoop() {
            window.kpiLoopStarted = true;
            fetchKPIs(); // Primera vez
            setInterval(fetchKPIs, 3000); // Luego cada 3 segundos
        }

        // --- FUNCIONES DE PRODUCTO ---
        async function loadBoxes() {
            try {
                const res = await fetch('/api/boxes');
                const boxes = await res.json();

                const boxList = document.getElementById('box-list');
                boxList.innerHTML = '';

                boxes.forEach(box => {
                    const btn = document.createElement('button');
                    btn.className = 'box-btn';
                    btn.onclick = () => selectBox(box.Description_Type);

                    const imgTag = box.image_path ? `<img src="${box.image_path}" class="box-image" alt="${box.Description_Type}">` : `<div class="box-image-placeholder">üì¶</div>`;

                    btn.innerHTML = `
                        ${imgTag}
                        <div class="box-content-info">
                            <span class="box-title">${box.Description_Type}</span>
                            <span class="caja-info">Box Type: ${box.box_type} | ${box.altura} x ${box.anchura} x ${box.largo}</span>
                        </div>
                    `;
                    boxList.appendChild(btn);
                });
            } catch (e) {
                document.getElementById('box-list').innerHTML = `<div style="color:#ff6b6b">Error al cargar</div>`;
            }
        }

        async function selectBox(description_type) {
            const resultDiv = document.getElementById('res-box');
            const loadingDiv = document.getElementById('loading-box');
            toggleUI(true, resultDiv, loadingDiv);

            try {
                const response = await fetch('/submit_box', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ Description_Type: description_type })
                });
                const data = await response.json();
                showMessage(response.ok, response.ok ? `‚úÖ ${data.message}` : `‚ùå ${data.error}`, resultDiv);
            } catch (error) {
                showMessage(false, `‚ùå Error: ${error.message}`, resultDiv);
            } finally {
                toggleUI(false, resultDiv, loadingDiv);
            }
        }

        // --- CREAR NUEVA CAJA ---
        document.getElementById('newBoxForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const resultDiv = document.getElementById('res-create');
            const loadingDiv = document.getElementById('loading-create');

            const formData = new FormData();
            formData.append('Description_Type', document.getElementById('box_name').value);
            formData.append('box_type', document.getElementById('box_type_id').value);
            formData.append('altura', document.getElementById('box_h').value);
            formData.append('anchura', document.getElementById('box_w').value);
            formData.append('largo', document.getElementById('box_l').value);

            const imageFile = document.getElementById('box_image').files[0];
            if (imageFile) {
                formData.append('image', imageFile);
            }

            toggleUI(true, resultDiv, loadingDiv, [document.getElementById('btn-create-box')]);

            try {
                const response = await fetch('/api/boxes', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (response.ok) {
                    showMessage(true, `‚úÖ ${data.message}`, resultDiv);
                    document.getElementById('newBoxForm').reset();
                    loadBoxes(); // Refrescar lista
                } else {
                    showMessage(false, `‚ùå ${data.error}`, resultDiv);
                }
            } catch (error) {
                showMessage(false, `‚ùå Error: ${error.message}`, resultDiv);
            } finally {
                toggleUI(false, resultDiv, loadingDiv, [document.getElementById('btn-create-box')]);
            }
        });

        // --- UTILIDADES ---
        function toggleUI(disabled, resDiv, logDiv, extraBtns = []) {
            document.querySelectorAll('#box-list button, .btn-start, .btn-stop, .btn-pause').forEach(b => b.disabled = disabled);
            extraBtns.forEach(b => b.disabled = disabled);
            logDiv.style.display = disabled ? 'block' : 'none';
            if (disabled) resDiv.style.display = 'none';
        }

        function showMessage(isSuccess, text, element) {
            element.innerHTML = text;
            element.className = 'message ' + (isSuccess ? 'success' : 'error');
            element.style.display = 'block';
        }
    </script>
</body>

</html>