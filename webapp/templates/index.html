<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control MES</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #121212;
            color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 40px 20px;
            box-sizing: border-box;
        }

        .main-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 30px;
            width: 100%;
            max-width: 1100px;
        }

        .card {
            background-color: #1e1e1e;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        h2 {
            color: #ffffff;
            font-size: 20px;
            margin-top: 0;
            margin-bottom: 25px;
            font-weight: 600;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }

        /* Botones de Control */
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        button {
            background-color: #2c2c2c;
            color: white;
            padding: 14px 20px;
            border: 1px solid #444;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        button:active {
            transform: scale(0.98);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        button:hover:not(:disabled) {
            background-color: #3d3d3d;
            border-color: #666;
        }

        /* Colores espec√≠ficos Control */
        .btn-start {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            border: none;
            box-shadow: 0 4px 15px rgba(56, 239, 125, 0.3);
        }

        .btn-start:hover:not(:disabled) {
            box-shadow: 0 6px 20px rgba(56, 239, 125, 0.5);
            background: linear-gradient(135deg, #15b7aa, #42f58c);
        }

        .btn-stop {
            background: linear-gradient(135deg, #cb2d3e, #ef473a);
            border: none;
            box-shadow: 0 4px 15px rgba(239, 71, 58, 0.3);
        }

        .btn-stop:hover:not(:disabled) {
            box-shadow: 0 6px 20px rgba(239, 71, 58, 0.5);
            background: linear-gradient(135deg, #d83446, #fa5245);
        }

        .btn-pause {
            background: linear-gradient(135deg, #f2994a, #f2c94c);
            border: none;
            box-shadow: 0 4px 15px rgba(242, 201, 76, 0.3);
            color: #111;
        }

        .btn-pause:hover:not(:disabled) {
            box-shadow: 0 6px 20px rgba(242, 201, 76, 0.5);
            background: linear-gradient(135deg, #faaa55, #fce055);
        }

        /* Formulario Nueva Caja */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
            font-size: 14px;
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 10px;
            background-color: #121212;
            border: 1px solid #444;
            color: white;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 14px;
        }

        input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }

        .btn-submit {
            background-color: #007bff;
            border: none;
            margin-top: 10px;
        }

        .btn-submit:hover:not(:disabled) {
            background-color: #0069d9;
        }

        /* Notificaciones y Carga */
        .message {
            margin-top: 20px;
            font-weight: bold;
            display: none;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
        }

        .success {
            background-color: rgba(40, 167, 69, 0.2);
            color: #4ade80;
            border: 1px solid rgba(40, 167, 69, 0.3);
        }

        .error {
            background-color: rgba(220, 53, 69, 0.2);
            color: #ff6b6b;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }

        .loading {
            margin-top: 20px;
            color: #aaa;
            display: none;
            font-size: 14px;
            text-align: center;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .caja-info {
            font-size: 12px;
            color: #aaa;
            font-weight: normal;
            display: block;
            margin-top: 4px;
        }

        .box-btn {
            justify-content: flex-start;
            text-align: left;
        }

        .box-image {
            width: 45px;
            height: 45px;
            object-fit: cover;
            border-radius: 6px;
            flex-shrink: 0;
        }

        .box-image-placeholder {
            width: 45px;
            height: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #444;
            border-radius: 6px;
            font-size: 20px;
            flex-shrink: 0;
        }

        .box-content-info {
            display: flex;
            flex-direction: column;
            text-align: left;
        }

        .box-title {
            font-size: 16px;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="main-container">

        <!-- SECCI√ìN 1: Control de M√°quina -->
        <div class="card">
            <h2>‚öôÔ∏è Control de M√°quina</h2>
            <div class="button-group">
                <button class="btn-start" onclick="sendControl(1)">
                    ‚ñ∂ START
                </button>
                <button class="btn-pause" onclick="sendControl(2)">
                    ‚è∏ PAUSE
                </button>
                <button class="btn-stop" onclick="sendControl(0)">
                    ‚èπ STOP
                </button>
            </div>
            <div id="loading-control" class="loading">
                <div class="spinner"></div> Enviando...
            </div>
            <div id="res-control" class="message"></div>
        </div>

        <!-- SECCI√ìN 2: Selecci√≥n de Producto -->
        <div class="card">
            <h2>üì¶ Producto (Cajas)</h2>
            <div id="box-list" class="button-group">
                <!-- Se llenar√° din√°micamente con JS -->
                <div style="text-align:center; color:#888;">Cargando cajas...</div>
            </div>
            <div id="loading-box" class="loading">
                <div class="spinner"></div> Configurando producto...
            </div>
            <div id="res-box" class="message"></div>
        </div>

        <!-- SECCI√ìN 3: Nueva Caja -->
        <div class="card">
            <h2>‚ûï Definir Nueva Caja</h2>
            <form id="newBoxForm">
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <div class="form-group" style="flex:2;">
                        <label>Nombre del formato</label>
                        <input type="text" id="box_name" placeholder="Ej: Extra Grande" required>
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label>ID Box Type</label>
                        <input type="number" id="box_type_id" placeholder="Ej: 4" required min="1">
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex:1;">
                        <label>Altura</label>
                        <input type="number" id="box_h" required min="1">
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label>Anchura</label>
                        <input type="number" id="box_w" required min="1">
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label>Largo</label>
                        <input type="number" id="box_l" required min="1">
                    </div>
                </div>
                <div class="form-group">
                    <label>Imagen del Producto (Opcional)</label>
                    <input type="file" id="box_image" accept="image/*"
                        style="background: none; border:none; padding: 0;">
                </div>
                <button type="submit" class="btn-submit" id="btn-create-box">Crear y Guardar</button>
            </form>
            <div id="loading-create" class="loading">
                <div class="spinner"></div> Guardando...
            </div>
            <div id="res-create" class="message"></div>
        </div>

    </div>

    <script>
        // Cargar cajas al iniciar la p√°gina
        document.addEventListener('DOMContentLoaded', loadBoxes);

        // --- FUNCIONES DE M√ÅQUINA (START/STOP/PAUSE) ---
        async function sendControl(valor) {
            const resultDiv = document.getElementById('res-control');
            const loadingDiv = document.getElementById('loading-control');
            toggleUI(true, resultDiv, loadingDiv);

            try {
                const response = await fetch('/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ valor: valor })
                });
                const data = await response.json();

                let cmdName = valor === 1 ? 'START' : (valor === 0 ? 'STOP' : 'PAUSE');
                showMessage(response.ok, response.ok ? `‚úÖ Comando <b>${cmdName}</b> ejecutado.` : `‚ùå ${data.error}`, resultDiv);
            } catch (error) {
                showMessage(false, `‚ùå Error: ${error.message}`, resultDiv);
            } finally {
                toggleUI(false, resultDiv, loadingDiv);
            }
        }

        // --- FUNCIONES DE PRODUCTO ---
        async function loadBoxes() {
            try {
                const res = await fetch('/api/boxes');
                const boxes = await res.json();

                const boxList = document.getElementById('box-list');
                boxList.innerHTML = '';

                boxes.forEach(box => {
                    const btn = document.createElement('button');
                    btn.className = 'box-btn';
                    btn.onclick = () => selectBox(box.Description_Type);

                    const imgTag = box.image_path ? `<img src="${box.image_path}" class="box-image" alt="${box.Description_Type}">` : `<div class="box-image-placeholder">üì¶</div>`;

                    btn.innerHTML = `
                        ${imgTag}
                        <div class="box-content-info">
                            <span class="box-title">${box.Description_Type}</span>
                            <span class="caja-info">Box Type: ${box.box_type} | ${box.altura} x ${box.anchura} x ${box.largo}</span>
                        </div>
                    `;
                    boxList.appendChild(btn);
                });
            } catch (e) {
                document.getElementById('box-list').innerHTML = `<div style="color:#ff6b6b">Error al cargar</div>`;
            }
        }

        async function selectBox(description_type) {
            const resultDiv = document.getElementById('res-box');
            const loadingDiv = document.getElementById('loading-box');
            toggleUI(true, resultDiv, loadingDiv);

            try {
                const response = await fetch('/submit_box', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ Description_Type: description_type })
                });
                const data = await response.json();
                showMessage(response.ok, response.ok ? `‚úÖ ${data.message}` : `‚ùå ${data.error}`, resultDiv);
            } catch (error) {
                showMessage(false, `‚ùå Error: ${error.message}`, resultDiv);
            } finally {
                toggleUI(false, resultDiv, loadingDiv);
            }
        }

        // --- CREAR NUEVA CAJA ---
        document.getElementById('newBoxForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const resultDiv = document.getElementById('res-create');
            const loadingDiv = document.getElementById('loading-create');

            const formData = new FormData();
            formData.append('Description_Type', document.getElementById('box_name').value);
            formData.append('box_type', document.getElementById('box_type_id').value);
            formData.append('altura', document.getElementById('box_h').value);
            formData.append('anchura', document.getElementById('box_w').value);
            formData.append('largo', document.getElementById('box_l').value);

            const imageFile = document.getElementById('box_image').files[0];
            if (imageFile) {
                formData.append('image', imageFile);
            }

            toggleUI(true, resultDiv, loadingDiv, [document.getElementById('btn-create-box')]);

            try {
                const response = await fetch('/api/boxes', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (response.ok) {
                    showMessage(true, `‚úÖ ${data.message}`, resultDiv);
                    document.getElementById('newBoxForm').reset();
                    loadBoxes(); // Refrescar lista
                } else {
                    showMessage(false, `‚ùå ${data.error}`, resultDiv);
                }
            } catch (error) {
                showMessage(false, `‚ùå Error: ${error.message}`, resultDiv);
            } finally {
                toggleUI(false, resultDiv, loadingDiv, [document.getElementById('btn-create-box')]);
            }
        });

        // --- UTILIDADES ---
        function toggleUI(disabled, resDiv, logDiv, extraBtns = []) {
            document.querySelectorAll('#box-list button, .btn-start, .btn-stop, .btn-pause').forEach(b => b.disabled = disabled);
            extraBtns.forEach(b => b.disabled = disabled);
            logDiv.style.display = disabled ? 'block' : 'none';
            if (disabled) resDiv.style.display = 'none';
        }

        function showMessage(isSuccess, text, element) {
            element.innerHTML = text;
            element.className = 'message ' + (isSuccess ? 'success' : 'error');
            element.style.display = 'block';
        }
    </script>
</body>

</html>